# =============================================================================
# DOCKER COMPOSE - {{ project_name }}
# =============================================================================
# Generated by Ansible for user {{ user_name }} (UID: {{ user_uid }})
# =============================================================================

version: "3.8"

services:
  {{ container_name }}:
    image: {{ image }}
    container_name: {{ container_name }}
    
    # -------------------------------------------------------------------------
    # GPU ACCESS
    # -------------------------------------------------------------------------
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
{% if gpus == 'all' %}
              count: all
{% else %}
              count: {{ gpus }}
{% endif %}
              capabilities: [gpu]
    
    # -------------------------------------------------------------------------
    # USER MAPPING - Container runs as your UID
    # -------------------------------------------------------------------------
    user: "{{ user_uid }}:{{ user_gid }}"
    
    # -------------------------------------------------------------------------
    # PORTS
    # -------------------------------------------------------------------------
    ports:
      - "{{ host_port }}:8888"      # Jupyter
      - "{{ host_port | int + 1 }}:6006"    # TensorBoard
    
    # -------------------------------------------------------------------------
    # VOLUMES
    # -------------------------------------------------------------------------
    volumes:
      # Your workspace - persistent storage
      - ./workspace:/workspace
      
      # Optional: shared datasets (read-only)
      # - {{ datasets_dir | default('/data/datasets') }}:/datasets:ro
    
    # -------------------------------------------------------------------------
    # RESOURCES
    # -------------------------------------------------------------------------
    mem_limit: {{ memory }}
    shm_size: {{ shm_size }}
    
    # -------------------------------------------------------------------------
    # ENVIRONMENT
    # -------------------------------------------------------------------------
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - PYTHONUNBUFFERED=1
      - PROJECT_NAME={{ project_name }}
      - USER_NAME={{ user_name }}
    
    # -------------------------------------------------------------------------
    # SETTINGS
    # -------------------------------------------------------------------------
    restart: {{ restart_policy }}
    working_dir: /workspace
    
    # -------------------------------------------------------------------------
    # LABELS
    # -------------------------------------------------------------------------
    labels:
      - "project={{ project_name }}"
      - "user={{ user_name }}"
      - "uid={{ user_uid }}"
      - "managed_by=ansible-container-management"
